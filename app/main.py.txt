"""FastAPI service for NTG Load Monitoring."""

from __future__ import annotations

from contextlib import asynccontextmanager
from pathlib import Path

from fastapi import FastAPI, Query
from fastapi.responses import FileResponse
from fastapi.staticfiles import StaticFiles
from pydantic import BaseModel

from app.database import get_db_metadata, get_latest_metric, get_metric_history, init_db


class HealthResponse(BaseModel):
    status: str
    db_path: str


class MetricRecord(BaseModel):
    id: int
    recorded_at: str
    cpu_percent: float
    memory_percent: float
    disk_percent: float


class LatestMetricResponse(BaseModel):
    message: str | None = None
    data: MetricRecord | None = None


class MetricHistoryResponse(BaseModel):
    data: list[MetricRecord]


@asynccontextmanager
async def lifespan(_: FastAPI):
    init_db()
    yield


app = FastAPI(title="NTG Load Monitoring", version="0.2.0", lifespan=lifespan)

STATIC_DIR = Path(__file__).resolve().parent.parent / "static"


@app.get("/api/health", response_model=HealthResponse)
def health() -> HealthResponse:
    return HealthResponse(status="ok", db_path=get_db_metadata()["db_path"])


@app.get("/api/metrics/latest", response_model=LatestMetricResponse)
def latest_metric() -> LatestMetricResponse:
    latest = get_latest_metric()
    if latest is None:
        return LatestMetricResponse(message="No metrics collected yet.", data=None)
    return LatestMetricResponse(data=MetricRecord(**latest))


@app.get("/api/metrics/history", response_model=MetricHistoryResponse)
def metric_history(limit: int = Query(50, ge=1, le=500)) -> MetricHistoryResponse:
    rows = [MetricRecord(**row) for row in get_metric_history(limit=limit)]
    return MetricHistoryResponse(data=rows)


app.mount("/static", StaticFiles(directory=STATIC_DIR), name="static")


@app.get("/")
def index() -> FileResponse:
    return FileResponse(STATIC_DIR / "index.html")
